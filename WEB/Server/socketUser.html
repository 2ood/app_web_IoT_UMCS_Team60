<!doctype html>
<html>
<head>
  <title>user socket test</title>
</head>
<style>
  form{  background: #acacac; margin:10px;}
  li {border-width: 0 0 2px 0 ;border-style: solid; padding-bottom:10px;}
  div {padding:10px;}
</style>
<body>
  <h1>user socket page</h1>
  <div id="my_info"></div>

  <div>
    <select id="f"></select>
    <button id="ff"> 들어감(get_in)</button>
    &nbsp;&nbsp;&nbsp;
    <select id="g"></select>
    <button id="gg"> 들어감(get_in)</button>
    &nbsp;&nbsp;&nbsp;
    <select id="h"></select>
    <button id="hh"> 들어감(get_in)</button>
    &nbsp;&nbsp;&nbsp;
    <select id="i"></select>
    <button id="ii"> 들어감(get_in)</button>
    &nbsp;&nbsp;&nbsp;

    <button id="get_out">비콘 영역에서 나옴<br>(get_out)</button>
  </div>

  <form action="" id="cannot_assemble">
    긴급소집 불응 사유 제출 (cannot_assemble)
    <input type="text" id="b" placeholder="사유" />
    <input type="submit" />
  </form>

  <form action="" id="move_request">
    [평시] 외부시설 이동요청 (move_request)
    <input type="number" id="a" placeholder="outside_id" />
    <input type="submit" />
  </form>

  <form action="" id="facility_request">
    [코호트] 공공시설 사용요청 (facility_request)
    <input type="number" id="c" placeholder="facility_id" />
    <input type="text" id="d" placeholder="HH:MM:SS" />
    <input type="text" id="e" placeholder="사유" />
    <input type="submit" />
  </form>

  <div id="messages"></div>
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.1/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    $(function () {
      jQuery(document).ready(function() {
        axios.get('/api/doom')
        .then(function(res) {
          for(b of res.data.data) 
            $('#f').append($('<option></option>').val(b.beacon_id).html(b.name));
        })
        axios.get('/api/outside_facility')
        .then(function(res) {
          for(b of res.data.data) 
            $('#g').append($('<option></option>').val(b.beacon_id).html(b.name));
        })
        axios.get('/api/doomroom')
        .then(function(res) {
          for(b of res.data.data) 
            $('#h').append($('<option></option>').val(b.beacon_id).html(b.doom_id + " / " + b.name));
        })
        axios.get('/api/doomfacility')
        .then(function(res) {
          for(b of res.data.data) 
            $('#i').append($('<option></option>').val(b.beacon_id).html(b.doom_id + " / " + b.name));
        })
      });

      const socket = io('/user', {
        transportOptions: {
          polling: {
            extraHeaders: {
              Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0YWciOiIyMC0zIiwibmFtZSI6Iuy1nOuzkeyepSIsInJhbmsiOiLrs5HsnqUiLCJyb29tX2lkIjo0LCJkb29tX2lkIjoxLCJpYXQiOjE2MzM1NDMwOTEsImV4cCI6MTY2NTA3OTA5MX0.VfDT4jie3-g0b0ODxWlkFInPh3GhKIIaGE6j9b87nZ0"
            },
          }
        }
      });

      $('#ff').click(function(e) {
        e.preventDefault(); 
        socket.emit('get_in', {beacon_id: $('#f').val()});
        return false;
      });
      $('#gg').click(function(e) {
        e.preventDefault(); 
        socket.emit('get_in', {beacon_id: $('#g').val()});
        return false;
      });
      $('#hh').click(function(e) {
        e.preventDefault(); 
        socket.emit('get_in', {beacon_id: $('#h').val()});
        return false;
      });
      $('#ii').click(function(e) {
        e.preventDefault(); 
        socket.emit('get_in', {beacon_id: $('#i').val()});
        return false;
      });

      $('#get_out').click(function(e) {
        e.preventDefault(); 
        socket.emit('get_out');
        return false;
      });

      $('#cannot_assemble').submit(function(e) {
        e.preventDefault(); 
        socket.emit('cannot_assemble', {description: $('#b').val()});
        return false;
      });

      $('#move_request').submit(function(e) {
        e.preventDefault(); 
        socket.emit('move_request', {outside_id: $('#a').val()});
        return false;
      });

      $('#facility_request').submit(function(e) {
        e.preventDefault(); 
        socket.emit('facility_request', {facility_id: $('#c').val(), desired_time: $('#d').val(), description: $('#e').val()});
        return false;
      });

      socket.once('my_info', function(user) { 
        $('#my_info').append(user.tag + " " + user.rank + " " + user.name + " 생활관id:" + user.doom_id); 
      });

      socket.on('to_cohort', function(msg) { 
        $('#messages').append($('<li>').text("[코호트 상황으로 전환!!]"));
      });

      socket.on('to_normal', function(msg) { 
        $('#messages').append($('<li>').text("[평시 상황으로 전환!!]"));
      });

      socket.on('assemble_command', function(msg) { 
        $('#messages').append($('<li>').text("[긴급소집 알림!!]"));
      });

      socket.on('move_approval', function(msg) { 
        $('#messages').append("[외부시설 사용요청 결재완료 알림]")
        $('#messages').append($('<li>').text(JSON.stringify(msg))); 
      });

      socket.on('facility_approval', function(msg) { 
        $('#messages').append("[공공시설 사용요청 결재완료 알림]")
        $('#messages').append($('<li>').text(JSON.stringify(msg))); 
      });

    });
  </script>
</body>
</html>
